<html>
   <head>
   </head>
   <body id='body'>
      <style>
         .on, .set, .off {
            margin: 1px;
         }
         .on, .set, .off {
            width: 12px;
            height: 12px;
            display:inline-block
         }
         .on {
            background-color: coral;
         }
         .set {
            background-color: red;
         }
         .off {
            background-color: black;
         }
         .lane {
            background-color: white;
         }
      </style>
      <script>
         // configuration parameters:
         let lanes = 3       // How many lanes
         let slots = 16      // How many cells in each lane
         let speed = 200     // How fast to increment the song position
                             //   {counter} by 1 (in milliseconds)
         let lane_sounds = [ // What sound to use for each lane
            { filename: "env9091.wav", pool: 4 },
            { filename: "MaxV - Roland808 - SD1010 11.WAV", pool: 4 },
            { filename: "MaxV - Roland808 - CH 39.WAV", pool: 4 },
         ]
         let counter = 0     // The current song position
                             // (increments by 1 every {speed} milliseconds)
         let seq = []        // Lane & slot data (our sequencer)
                             // array of arrays  (i.e. array of seq_lanes,
                             //                   which are arrays of slotdata)

         // called when clicking on any slot
         function onSlotClick( slotdata ) {
            // just toggle the state from 'off' (false) to 'set' (true)
            slotdata.state = !slotdata.state
         }

         // initialize the sequencer track
         // everything is driven off the configuration parameters
         function init() {
            // init the sound manager (aka. sound pools)
            // so that sounds can overlap when played too close together
            // each lane allocates {pool} number of duplicates of the sound
            // when trigger()ing the sound, play the next one in roundrobin order
            for (let s of lane_sounds) {
               s.sound_pool = []
               for (let i = 0; i < s.pool; ++i) {
                  s.sound_pool.push( new Audio( s.filename ) )
               }
               s.pool_counter = 0
               // this is how we trigger a sound from the pool
               s.trigger = () => {
                  s.sound_pool[s.pool_counter].play();
                  s.pool_counter = (s.pool_counter + 1) % s.pool
               }
            }

            // create the lanes/slots into the DOM, like this:
            // <div id="lane0" class="lane">
            //   <div id="a00"></div>
            //   ...
            //   <div id="a08"></div>
            // </div>
            for (let lane_num = 0; lane_num < lanes; ++lane_num) {
               let lane = document.createElement("div");
               lane.id = 'lane' + lane_num;
               lane.className = 'lane';
               for (let slot_num = 0; slot_num < slots; ++slot_num) {
                  let slot = document.createElement("div");
                  slot.id = 'a' + lane_num + slot_num;
                  lane.appendChild( slot );
               }
               body.appendChild( lane );
            }

            // set up the lanes, initialize the data for each slot
            for (let lane = 0; lane < lanes; ++lane) {
               // each lane has slots
               let seq_lane = []
               for (let slot = 0; slot < slots; ++slot) {
                  // each slot has slotdata
                  let slotdata = {
                     element: document.getElementById( 'a' + lane + slot ),
                     state: false,
                     sound_pool: lane_sounds[lane]
                  }
                  // setup the cell's onclick to call onSlotClick
                  slotdata.element.onclick = () => onSlotClick( slotdata )
                  seq_lane.push( slotdata )
               }
               seq.push( seq_lane )
            }
         }

         // called when it's time to trigger a cell
         function trigger( slotdata ) {
            slotdata.sound_pool.trigger()
         }

         // step the sequencer one step
         function step() {
            // reset all cells to show their 'set' state (or 'off' if not set)
            for (let seq_lane of seq) {
               for (let slot of seq_lane) {
                  slot.element.className = slot.state ? 'set' : 'off'
               }
            }

            // show where the song position is by turning 'on' the cell
            for (let lane in seq) {
               seq[lane][counter].element.className = 'on'

               // if the cell is 'set', then trigger it!
               if (seq[lane][counter].state) {
                  trigger( seq[lane][counter] );
               }
            }

            // advance the song pointer (use mod so it wraps around)
            counter = (counter + 1) % slots
         }

         // go!
         init()
         setInterval( () => step(), speed )
      </script>
   </body>
</html>
